<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í€˜ìŠ¤íŠ¸ ì—ë””í„°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Courier New', monospace;
            background-color: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë°” */
        .nav-bar {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #16213e;
            border-radius: 10px;
            border: 1px solid #0f3460;
        }

        .nav-btn {
            padding: 10px 20px;
            background: #0f3460;
            border: 2px solid transparent;
            border-radius: 5px;
            color: #eee;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: #1a4a7a;
            transform: translateY(-2px);
        }

        .nav-btn.active {
            border-color: #ffd700;
            background: #1a4a7a;
            color: #ffd700;
        }

        .nav-btn.game-btn {
            background: #2d5016;
        }

        .nav-btn.game-btn:hover {
            background: #3d6a1e;
        }

        h1 {
            text-align: center;
            color: #ffd700;
            margin-bottom: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .panel {
            background: #16213e;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #0f3460;
        }

        .panel h2 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 1px solid #0f3460;
            padding-bottom: 10px;
        }

        /* í€˜ìŠ¤íŠ¸ ëª©ë¡ */
        .quest-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 500px;
            overflow-y: auto;
        }

        .quest-btn {
            padding: 10px;
            background: #0f3460;
            border: 2px solid transparent;
            border-radius: 5px;
            color: #eee;
            cursor: pointer;
            text-align: left;
            font-family: inherit;
            font-size: 14px;
        }

        .quest-btn:hover {
            background: #1a4a7a;
        }

        .quest-btn.active {
            border-color: #ffd700;
            background: #1a4a7a;
        }

        .quest-btn .status {
            font-size: 12px;
            color: #888;
        }

        /* ì…ë ¥ í•„ë“œ */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            background: #0f3460;
            border: 1px solid #1a4a7a;
            border-radius: 5px;
            color: #eee;
            font-family: inherit;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ffd700;
        }

        /* ëª©í‘œ ë¦¬ìŠ¤íŠ¸ */
        .objectives-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }

        .objective-item {
            background: #0f3460;
            padding: 10px;
            border-radius: 5px;
            display: grid;
            grid-template-columns: 100px 1fr 80px 40px;
            gap: 10px;
            align-items: center;
        }

        .objective-item select,
        .objective-item input {
            padding: 8px;
            background: #16213e;
            border: 1px solid #1a4a7a;
            border-radius: 3px;
            color: #eee;
            font-family: inherit;
        }

        .objective-item .btn-remove {
            padding: 5px 10px;
            background: #aa3333;
            border: none;
            border-radius: 3px;
            color: #fff;
            cursor: pointer;
        }

        .objective-item .btn-remove:hover {
            background: #cc4444;
        }

        /* ë³´ìƒ ì…ë ¥ */
        .rewards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .reward-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .reward-input label {
            font-size: 12px;
            color: #888;
        }

        .reward-input input {
            padding: 8px;
            background: #0f3460;
            border: 1px solid #1a4a7a;
            border-radius: 5px;
            color: #eee;
            font-family: inherit;
        }

        /* ë²„íŠ¼ */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            background: #0f3460;
            border: none;
            border-radius: 5px;
            color: #eee;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
        }

        .btn:hover {
            background: #1a4a7a;
        }

        .btn-primary {
            background: #00aa55;
        }

        .btn-primary:hover {
            background: #00cc66;
        }

        .btn-danger {
            background: #aa3333;
        }

        .btn-danger:hover {
            background: #cc4444;
        }

        .btn-warning {
            background: #aa8800;
        }

        .btn-warning:hover {
            background: #ccaa00;
        }

        /* ì½”ë“œ ì¶œë ¥ */
        .code-output {
            background: #000;
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            color: #0f0;
            display: none;
        }

        /* ë¯¸ë¦¬ë³´ê¸° */
        .preview-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #0f3460;
        }

        .preview-box {
            background: #000;
            padding: 15px;
            border-radius: 10px;
            color: #ffd700;
        }

        .preview-box h3 {
            margin-bottom: 10px;
        }

        .preview-box .description {
            color: #aaa;
            margin-bottom: 10px;
        }

        .preview-box .objective {
            color: #0f0;
            margin: 5px 0;
        }

        .preview-box .reward {
            color: #ffd700;
            margin-top: 10px;
        }

        /* ë„ì›€ë§ */
        .help-text {
            font-size: 12px;
            color: #888;
            margin-top: 15px;
            line-height: 1.5;
        }

        /* ìƒˆ í€˜ìŠ¤íŠ¸ ë²„íŠ¼ */
        .new-quest-btn {
            width: 100%;
            padding: 15px;
            background: #0f3460;
            border: 2px dashed #1a4a7a;
            border-radius: 5px;
            color: #888;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            margin-top: 10px;
        }

        .new-quest-btn:hover {
            border-color: #ffd700;
            color: #ffd700;
        }

        /* ê°€ì ¸ì˜¤ê¸° ì˜ì—­ */
        #importArea {
            margin-top: 15px;
        }

        #importArea textarea {
            width: 100%;
            height: 150px;
            background: #000;
            color: #0f0;
            border: 1px solid #0f3460;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <div class="nav-bar">
        <a href="pattern_editor.html" class="nav-btn">ğŸ¨ ëª¬ìŠ¤í„° ì•„íŠ¸ ì—ë””í„°</a>
        <a href="quest_editor.html" class="nav-btn active">ğŸ“œ í€˜ìŠ¤íŠ¸ ì—ë””í„°</a>
        <a href="index.html" class="nav-btn game-btn">ğŸ® ê²Œì„ìœ¼ë¡œ</a>
    </div>

    <h1>ğŸ“œ í€˜ìŠ¤íŠ¸ ì—ë””í„°</h1>

    <div class="container">
        <!-- ì™¼ìª½: í€˜ìŠ¤íŠ¸ ëª©ë¡ -->
        <div class="panel">
            <h2>ğŸ“‹ í€˜ìŠ¤íŠ¸ ëª©ë¡</h2>
            <div class="quest-list" id="questList"></div>
            <button class="new-quest-btn" onclick="createNewQuest()">+ ìƒˆ í€˜ìŠ¤íŠ¸ ì¶”ê°€</button>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì—ë””í„° -->
        <div class="panel">
            <h2>âœï¸ í€˜ìŠ¤íŠ¸ í¸ì§‘</h2>

            <div class="form-group">
                <label>í€˜ìŠ¤íŠ¸ ID (ì˜ë¬¸, ê³ ìœ ê°’)</label>
                <input type="text" id="questId" placeholder="ì˜ˆ: rat_hunt">
            </div>

            <div class="form-group">
                <label>í€˜ìŠ¤íŠ¸ ì´ë¦„</label>
                <input type="text" id="questName" placeholder="ì˜ˆ: ì¥ ì‚¬ëƒ¥">
            </div>

            <div class="form-group">
                <label>ì„¤ëª…</label>
                <textarea id="questDescription" placeholder="í€˜ìŠ¤íŠ¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>

            <h3 style="color: #ffd700; margin: 20px 0 10px 0;">ğŸ¯ ëª©í‘œ</h3>
            <div class="objectives-list" id="objectivesList"></div>
            <button class="btn" onclick="addObjective()">+ ëª©í‘œ ì¶”ê°€</button>

            <h3 style="color: #ffd700; margin: 20px 0 10px 0;">ğŸ ë³´ìƒ</h3>
            <div class="rewards-grid">
                <div class="reward-input">
                    <label>ğŸ’° ê³¨ë“œ</label>
                    <input type="number" id="rewardGold" value="0" min="0">
                </div>
                <div class="reward-input">
                    <label>â­ ê²½í—˜ì¹˜</label>
                    <input type="number" id="rewardXp" value="0" min="0">
                </div>
                <div class="reward-input">
                    <label>ğŸ”‘ ì¶œí˜„ ì¸µ</label>
                    <input type="number" id="questFloor" value="1" min="1" max="15">
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveQuest()">ğŸ’¾ ì €ì¥</button>
                <button class="btn" onclick="exportCode()">ğŸ“‹ ì½”ë“œ ë³µì‚¬</button>
                <button class="btn" onclick="exportAllQuests()">ğŸ“„ ì „ì²´ ë‚´ë³´ë‚´ê¸°</button>
                <button class="btn" onclick="toggleImportArea()">ğŸ“¥ ê°€ì ¸ì˜¤ê¸°</button>
                <button class="btn btn-danger" onclick="deleteQuest()">ğŸ—‘ï¸ ì‚­ì œ</button>
            </div>

            <div id="importArea" style="display: none;">
                <textarea id="importCode" placeholder="ì—¬ê¸°ì— í€˜ìŠ¤íŠ¸ ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-primary" onclick="importCode()">âœ… ê°€ì ¸ì˜¤ê¸°</button>
                    <button class="btn" onclick="toggleImportArea()">ì·¨ì†Œ</button>
                </div>
            </div>

            <div class="code-output" id="codeOutput"></div>

            <div class="preview-section">
                <h3 style="color: #ffd700; margin-bottom: 10px;">ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°</h3>
                <div class="preview-box" id="previewBox">
                    <div id="previewContent">í€˜ìŠ¤íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
                </div>
            </div>

            <div class="help-text">
                <strong>ì‚¬ìš©ë²•:</strong><br>
                1. ì™¼ìª½ì—ì„œ í€˜ìŠ¤íŠ¸ ì„ íƒ ë˜ëŠ” ìƒˆë¡œ ì¶”ê°€<br>
                2. ID, ì´ë¦„, ì„¤ëª… ì…ë ¥<br>
                3. ëª©í‘œ ì¶”ê°€ (ì²˜ì¹˜, ìˆ˜ì§‘, ë„ë‹¬ ë“±)<br>
                4. ë³´ìƒ ì„¤ì •<br>
                5. ì €ì¥ í›„ ì½”ë“œ ë³µì‚¬í•˜ì—¬ game.jsì— ì ìš©
            </div>
        </div>
    </div>

    <script>
        // ëª¬ìŠ¤í„° ëª©ë¡ (game.jsì˜ MONSTER_DATA ê¸°ë°˜)
        const MONSTERS = [
            'ì¥', 'ë°•ì¥', 'ê±°ë¯¸', 'ê³ ë¸”ë¦°', 'ìŠ¬ë¼ì„', 'ìŠ¤ì¼ˆë ˆí†¤',
            'ì˜¤í¬', 'ì¢€ë¹„', 'ëŠ‘ëŒ€', 'íŠ¸ë¡¤', 'ê³°', 'ë¯¸ë…¸íƒ€ìš°ë¡œìŠ¤', 'ë“œë˜ê³¤'
        ];

        // ì•„ì´í…œ ëª©ë¡
        const ITEMS = [
            'ì²´ë ¥ ë¬¼ì•½', 'ë§ˆë‚˜ ë¬¼ì•½', 'ì—´ì‡ ', 'ê¸ˆí™”', 'ë¬´ê¸°', 'ë°©ì–´êµ¬', 'ìŠ¤í¬ë¡¤'
        ];

        // ëª©í‘œ íƒ€ì…
        const OBJECTIVE_TYPES = {
            'kill': 'ì²˜ì¹˜',
            'collect': 'ìˆ˜ì§‘',
            'reach': 'ë„ë‹¬',
            'talk': 'ëŒ€í™”',
            'use': 'ì‚¬ìš©'
        };

        // í€˜ìŠ¤íŠ¸ ë°ì´í„°
        let quests = {};
        let currentQuestId = null;

        // ê¸°ë³¸ í€˜ìŠ¤íŠ¸ ë°ì´í„°
        const DEFAULT_QUESTS = {
            'rat_hunt': {
                id: 'rat_hunt',
                name: 'ì¥ ì‚¬ëƒ¥',
                description: 'ë§ˆì„ ì°½ê³ ì˜ ì¥ë¥¼ ì²˜ì¹˜í•˜ë¼.',
                objectives: [{ type: 'kill', target: 'ì¥', required: 5 }],
                rewards: { gold: 50, xp: 0 },
                floor: 1
            },
            'goblin_threat': {
                id: 'goblin_threat',
                name: 'ê³ ë¸”ë¦°ì˜ ìœ„í˜‘',
                description: 'ë˜ì „ì— ì¶œëª°í•˜ëŠ” ê³ ë¸”ë¦°ì„ ì²˜ì¹˜í•˜ë¼.',
                objectives: [{ type: 'kill', target: 'ê³ ë¸”ë¦°', required: 3 }],
                rewards: { gold: 100, xp: 50 },
                floor: 3
            },
            'spider_nest': {
                id: 'spider_nest',
                name: 'ê±°ë¯¸ ì†Œêµ´',
                description: 'ê±°ë¯¸êµ´ì˜ ê±°ë¯¸ë“¤ì„ ì†Œíƒ•í•˜ë¼.',
                objectives: [{ type: 'kill', target: 'ê±°ë¯¸', required: 5 }],
                rewards: { gold: 80, xp: 40 },
                floor: 2
            },
            'undead_purge': {
                id: 'undead_purge',
                name: 'ì–¸ë°ë“œ ì •í™”',
                description: 'ìŠ¤ì¼ˆë ˆí†¤ê³¼ ì¢€ë¹„ë¥¼ ì²˜ì¹˜í•˜ì—¬ ë˜ì „ì„ ì •í™”í•˜ë¼.',
                objectives: [
                    { type: 'kill', target: 'ìŠ¤ì¼ˆë ˆí†¤', required: 3 },
                    { type: 'kill', target: 'ì¢€ë¹„', required: 2 }
                ],
                rewards: { gold: 150, xp: 80 },
                floor: 4
            },
            'dragon_slayer': {
                id: 'dragon_slayer',
                name: 'ë“œë˜ê³¤ ìŠ¬ë ˆì´ì–´',
                description: 'ë˜ì „ ê¹Šì€ ê³³ì˜ ë“œë˜ê³¤ì„ ì²˜ì¹˜í•˜ë¼.',
                objectives: [{ type: 'kill', target: 'ë“œë˜ê³¤', required: 1 }],
                rewards: { gold: 500, xp: 300 },
                floor: 13
            },
            'deep_exploration': {
                id: 'deep_exploration',
                name: 'ì‹¬ì¸µ íƒí—˜',
                description: 'ë˜ì „ 10ì¸µì— ë„ë‹¬í•˜ë¼.',
                objectives: [{ type: 'reach', target: '10ì¸µ', required: 1 }],
                rewards: { gold: 200, xp: 150 },
                floor: 1
            }
        };

        // ì´ˆê¸°í™”
        function init() {
            // ì €ì¥ëœ í€˜ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
            const saved = localStorage.getItem('quest_editor_data');
            if (saved) {
                try {
                    quests = JSON.parse(saved);
                } catch (e) {
                    console.error('ì €ì¥ëœ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
                    quests = JSON.parse(JSON.stringify(DEFAULT_QUESTS));
                }
            } else {
                quests = JSON.parse(JSON.stringify(DEFAULT_QUESTS));
            }

            renderQuestList();

            // ì²« ë²ˆì§¸ í€˜ìŠ¤íŠ¸ ì„ íƒ
            const firstId = Object.keys(quests)[0];
            if (firstId) {
                selectQuest(firstId);
            }
        }

        // í€˜ìŠ¤íŠ¸ ëª©ë¡ ë Œë”ë§
        function renderQuestList() {
            const container = document.getElementById('questList');
            container.innerHTML = '';

            for (const [id, quest] of Object.entries(quests)) {
                const btn = document.createElement('button');
                btn.className = `quest-btn ${id === currentQuestId ? 'active' : ''}`;
                btn.innerHTML = `
                    <div>${quest.name}</div>
                    <div class="status">${quest.floor}ì¸µ | ${quest.objectives.length}ê°œ ëª©í‘œ</div>
                `;
                btn.onclick = () => selectQuest(id);
                container.appendChild(btn);
            }
        }

        // í€˜ìŠ¤íŠ¸ ì„ íƒ
        function selectQuest(id) {
            currentQuestId = id;
            const quest = quests[id];

            document.getElementById('questId').value = quest.id;
            document.getElementById('questName').value = quest.name;
            document.getElementById('questDescription').value = quest.description;
            document.getElementById('rewardGold').value = quest.rewards.gold || 0;
            document.getElementById('rewardXp').value = quest.rewards.xp || 0;
            document.getElementById('questFloor').value = quest.floor || 1;

            renderObjectives(quest.objectives);
            renderQuestList();
            updatePreview();
        }

        // ëª©í‘œ ë Œë”ë§
        function renderObjectives(objectives) {
            const container = document.getElementById('objectivesList');
            container.innerHTML = '';

            objectives.forEach((obj, index) => {
                const item = document.createElement('div');
                item.className = 'objective-item';

                // íƒ€ì… ì„ íƒ
                let typeOptions = Object.entries(OBJECTIVE_TYPES)
                    .map(([val, label]) => `<option value="${val}" ${obj.type === val ? 'selected' : ''}>${label}</option>`)
                    .join('');

                // ëŒ€ìƒ ì„ íƒ (íƒ€ì…ì— ë”°ë¼)
                let targetOptions = '';
                if (obj.type === 'kill') {
                    targetOptions = MONSTERS.map(m =>
                        `<option value="${m}" ${obj.target === m ? 'selected' : ''}>${m}</option>`
                    ).join('');
                } else if (obj.type === 'collect') {
                    targetOptions = ITEMS.map(i =>
                        `<option value="${i}" ${obj.target === i ? 'selected' : ''}>${i}</option>`
                    ).join('');
                } else {
                    targetOptions = `<option value="${obj.target}">${obj.target}</option>`;
                }

                item.innerHTML = `
                    <select onchange="updateObjectiveType(${index}, this.value)">
                        ${typeOptions}
                    </select>
                    <select onchange="updateObjectiveTarget(${index}, this.value)" id="target_${index}">
                        ${targetOptions}
                    </select>
                    <input type="number" value="${obj.required}" min="1"
                           onchange="updateObjectiveRequired(${index}, this.value)">
                    <button class="btn-remove" onclick="removeObjective(${index})">âœ•</button>
                `;

                // ë„ë‹¬/ëŒ€í™” ë“±ì€ í…ìŠ¤íŠ¸ ì…ë ¥ìœ¼ë¡œ
                if (obj.type === 'reach' || obj.type === 'talk' || obj.type === 'use') {
                    const targetSelect = item.querySelector(`#target_${index}`);
                    const textInput = document.createElement('input');
                    textInput.type = 'text';
                    textInput.value = obj.target;
                    textInput.placeholder = obj.type === 'reach' ? 'ì˜ˆ: 10ì¸µ' : 'ëŒ€ìƒ ì´ë¦„';
                    textInput.onchange = (e) => updateObjectiveTarget(index, e.target.value);
                    targetSelect.replaceWith(textInput);
                }

                container.appendChild(item);
            });
        }

        // ëª©í‘œ ì¶”ê°€
        function addObjective() {
            if (!currentQuestId) return;
            quests[currentQuestId].objectives.push({
                type: 'kill',
                target: 'ì¥',
                required: 1
            });
            renderObjectives(quests[currentQuestId].objectives);
            updatePreview();
        }

        // ëª©í‘œ ì œê±°
        function removeObjective(index) {
            if (!currentQuestId) return;
            quests[currentQuestId].objectives.splice(index, 1);
            renderObjectives(quests[currentQuestId].objectives);
            updatePreview();
        }

        // ëª©í‘œ íƒ€ì… ì—…ë°ì´íŠ¸
        function updateObjectiveType(index, value) {
            if (!currentQuestId) return;
            quests[currentQuestId].objectives[index].type = value;

            // íƒ€ì…ì— ë”°ë¼ ê¸°ë³¸ ëŒ€ìƒ ì„¤ì •
            if (value === 'kill') {
                quests[currentQuestId].objectives[index].target = 'ì¥';
            } else if (value === 'collect') {
                quests[currentQuestId].objectives[index].target = 'ì²´ë ¥ ë¬¼ì•½';
            } else if (value === 'reach') {
                quests[currentQuestId].objectives[index].target = '10ì¸µ';
            } else {
                quests[currentQuestId].objectives[index].target = '';
            }

            renderObjectives(quests[currentQuestId].objectives);
            updatePreview();
        }

        // ëª©í‘œ ëŒ€ìƒ ì—…ë°ì´íŠ¸
        function updateObjectiveTarget(index, value) {
            if (!currentQuestId) return;
            quests[currentQuestId].objectives[index].target = value;
            updatePreview();
        }

        // ëª©í‘œ í•„ìš” ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸
        function updateObjectiveRequired(index, value) {
            if (!currentQuestId) return;
            quests[currentQuestId].objectives[index].required = parseInt(value) || 1;
            updatePreview();
        }

        // ìƒˆ í€˜ìŠ¤íŠ¸ ìƒì„±
        function createNewQuest() {
            const id = 'quest_' + Date.now();
            quests[id] = {
                id: id,
                name: 'ìƒˆ í€˜ìŠ¤íŠ¸',
                description: 'í€˜ìŠ¤íŠ¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.',
                objectives: [{ type: 'kill', target: 'ì¥', required: 1 }],
                rewards: { gold: 50, xp: 0 },
                floor: 1
            };
            selectQuest(id);
        }

        // í€˜ìŠ¤íŠ¸ ì €ì¥
        function saveQuest() {
            if (!currentQuestId) return;

            const newId = document.getElementById('questId').value.trim();
            const name = document.getElementById('questName').value.trim();
            const description = document.getElementById('questDescription').value.trim();
            const gold = parseInt(document.getElementById('rewardGold').value) || 0;
            const xp = parseInt(document.getElementById('rewardXp').value) || 0;
            const floor = parseInt(document.getElementById('questFloor').value) || 1;

            if (!newId || !name) {
                alert('IDì™€ ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
                return;
            }

            // IDê°€ ë³€ê²½ëœ ê²½ìš°
            if (newId !== currentQuestId) {
                if (quests[newId]) {
                    alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” IDì…ë‹ˆë‹¤.');
                    return;
                }
                delete quests[currentQuestId];
                currentQuestId = newId;
            }

            quests[currentQuestId] = {
                id: newId,
                name: name,
                description: description,
                objectives: quests[currentQuestId]?.objectives || [{ type: 'kill', target: 'ì¥', required: 1 }],
                rewards: { gold, xp },
                floor: floor
            };

            localStorage.setItem('quest_editor_data', JSON.stringify(quests));
            renderQuestList();
            updatePreview();
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // í€˜ìŠ¤íŠ¸ ì‚­ì œ
        function deleteQuest() {
            if (!currentQuestId) return;

            if (!confirm(`'${quests[currentQuestId].name}' í€˜ìŠ¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            delete quests[currentQuestId];
            localStorage.setItem('quest_editor_data', JSON.stringify(quests));

            const firstId = Object.keys(quests)[0];
            if (firstId) {
                selectQuest(firstId);
            } else {
                currentQuestId = null;
                document.getElementById('questId').value = '';
                document.getElementById('questName').value = '';
                document.getElementById('questDescription').value = '';
                document.getElementById('objectivesList').innerHTML = '';
            }

            renderQuestList();
        }

        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updatePreview() {
            if (!currentQuestId) return;

            const quest = quests[currentQuestId];
            const objHtml = quest.objectives.map(obj => {
                const typeLabel = OBJECTIVE_TYPES[obj.type] || obj.type;
                return `<div class="objective">â–¸ ${typeLabel}: ${obj.target} (0/${obj.required})</div>`;
            }).join('');

            let rewardText = '';
            if (quest.rewards.gold) rewardText += `ğŸ’° ${quest.rewards.gold} ê³¨ë“œ `;
            if (quest.rewards.xp) rewardText += `â­ ${quest.rewards.xp} XP`;

            document.getElementById('previewContent').innerHTML = `
                <h3>ğŸ“œ ${quest.name}</h3>
                <div class="description">${quest.description}</div>
                ${objHtml}
                ${rewardText ? `<div class="reward">ë³´ìƒ: ${rewardText}</div>` : ''}
                <div style="color: #888; font-size: 12px; margin-top: 10px;">ì¶œí˜„: ${quest.floor}ì¸µ</div>
            `;
        }

        // ì½”ë“œ ë³µì‚¬
        function exportCode() {
            if (!currentQuestId) return;

            const quest = quests[currentQuestId];
            const objStr = quest.objectives.map(obj =>
                `{ type: '${obj.type}', target: '${obj.target}', required: ${obj.required}, current: 0 }`
            ).join(',\n            ');

            const code = `this.player.questLog.addQuest(new Quest(
    '${quest.id}', '${quest.name}',
    '${quest.description}',
    [${objStr}],
    { gold: ${quest.rewards.gold || 0}, xp: ${quest.rewards.xp || 0} }
));`;

            document.getElementById('codeOutput').style.display = 'block';
            document.getElementById('codeOutput').textContent = code;

            navigator.clipboard.writeText(code).then(() => {
                alert('ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        }

        // ì „ì²´ ë‚´ë³´ë‚´ê¸°
        function exportAllQuests() {
            let code = '// í€˜ìŠ¤íŠ¸ ë°ì´í„° (game.jsì˜ initPlayer í•¨ìˆ˜ì— ì¶”ê°€)\n\n';

            // ì¸µë³„ë¡œ ì •ë ¬
            const sortedQuests = Object.values(quests).sort((a, b) => a.floor - b.floor);

            for (const quest of sortedQuests) {
                const objStr = quest.objectives.map(obj =>
                    `{ type: '${obj.type}', target: '${obj.target}', required: ${obj.required}, current: 0 }`
                ).join(',\n            ');

                code += `// ${quest.floor}ì¸µ - ${quest.name}
this.player.questLog.addQuest(new Quest(
    '${quest.id}', '${quest.name}',
    '${quest.description}',
    [${objStr}],
    { gold: ${quest.rewards.gold || 0}, xp: ${quest.rewards.xp || 0} }
));

`;
            }

            document.getElementById('codeOutput').style.display = 'block';
            document.getElementById('codeOutput').textContent = code;

            navigator.clipboard.writeText(code).then(() => {
                alert('ì „ì²´ ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\ngame.jsì˜ initPlayer í•¨ìˆ˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.');
            });
        }

        // ê°€ì ¸ì˜¤ê¸° í† ê¸€
        function toggleImportArea() {
            const area = document.getElementById('importArea');
            area.style.display = area.style.display === 'none' ? 'block' : 'none';
            if (area.style.display === 'block') {
                document.getElementById('importCode').value = '';
                document.getElementById('importCode').focus();
            }
        }

        // ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        function importCode() {
            const code = document.getElementById('importCode').value.trim();
            if (!code) {
                alert('ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                // Quest ìƒì„±ì í˜¸ì¶œ íŒŒì‹±
                const matches = code.matchAll(/new Quest\s*\(\s*'([^']+)',\s*'([^']+)',\s*'([^']+)',\s*\[([\s\S]*?)\],\s*\{([^}]+)\}\s*\)/g);

                let importedCount = 0;
                for (const match of matches) {
                    const id = match[1];
                    const name = match[2];
                    const description = match[3];
                    const objectivesStr = match[4];
                    const rewardsStr = match[5];

                    // ëª©í‘œ íŒŒì‹±
                    const objectives = [];
                    const objMatches = objectivesStr.matchAll(/\{\s*type:\s*'([^']+)',\s*target:\s*'([^']+)',\s*required:\s*(\d+)/g);
                    for (const objMatch of objMatches) {
                        objectives.push({
                            type: objMatch[1],
                            target: objMatch[2],
                            required: parseInt(objMatch[3])
                        });
                    }

                    // ë³´ìƒ íŒŒì‹±
                    const goldMatch = rewardsStr.match(/gold:\s*(\d+)/);
                    const xpMatch = rewardsStr.match(/xp:\s*(\d+)/);

                    quests[id] = {
                        id,
                        name,
                        description,
                        objectives,
                        rewards: {
                            gold: goldMatch ? parseInt(goldMatch[1]) : 0,
                            xp: xpMatch ? parseInt(xpMatch[1]) : 0
                        },
                        floor: 1
                    };
                    importedCount++;
                }

                if (importedCount === 0) {
                    throw new Error('ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” í€˜ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }

                localStorage.setItem('quest_editor_data', JSON.stringify(quests));
                renderQuestList();
                toggleImportArea();
                alert(`${importedCount}ê°œì˜ í€˜ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!`);

            } catch (e) {
                alert('ì½”ë“œ íŒŒì‹± ì˜¤ë¥˜:\n' + e.message);
                console.error('Import error:', e);
            }
        }

        // ì´ˆê¸°í™”
        window.onload = init;
    </script>
</body>
</html>
